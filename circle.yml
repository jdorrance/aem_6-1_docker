machine:
  services:
    - docker

dependencies:
  pre: 
    # the AWS credentials must be set upin the CircleCI build
    - pip install awscli
    # forces a docker login against the AWS generated access token
    - eval $(aws ecr get-login --region us-east-1)
    # attempt to get the 'latest' docker base, this will aid in caching, then build - and tag with the circle build number
    - docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest || true
    - docker build -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM base/.
    - docker tag 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest aem_6-1_base
    # author
    #- docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest || true
    #- docker tag 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest aem_6-1_author 
    # publish
    #- docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest || true
    #- docker tag 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest aem_6-1_publish 
    # dispatcher
    #- docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:latest || true
    #- docker tag 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:latest aem_6-1_dispatcher 
  override:
    - docker images
    # now for author
    - docker build -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM author/.
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM aem_6-1_author 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM aem_6-1_author:latest 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest 
    # now for publish
    - docker build -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM publish/.
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM aem_6-1_publish 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM aem_6-1_publish:latest 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest 
    # now for dispatcher
    - docker build -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:$CIRCLE_BUILD_NUM dispatcher/.
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:$CIRCLE_BUILD_NUM aem_6-1_dispatcher 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:$CIRCLE_BUILD_NUM aem_6-1_dispatcher:latest 
    - docker tag  781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:$CIRCLE_BUILD_NUM 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:latest 
test:
  override:
    # make sure we can run the container
    - docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM /bin/sh -c ps aux
    #- docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM /bin/sh -c ps aux
    #- docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM /bin/sh -c ps aux

deployment:
  production:
    branch: master
    commands:
      # login again for good measure, and push both the latest tag and tagged by build number images
      # push base
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM
      # push author
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM
      # push publish
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM
      # push dispatcer
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_dispatcher:$CIRCLE_BUILD_NUM