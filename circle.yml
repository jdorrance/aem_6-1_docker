machine:
  services:
    - docker

dependencies:
  pre: 
    # the AWS credentials must be set upin the CircleCI build
    - pip install awscli
    # forces a docker login against the AWS generated access token
    - eval $(aws ecr get-login --region us-east-1)
  override:
    # attempt to get the 'latest' docker base, this will aid in caching, then build - and tag with the circle build number
    - docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest || true
    - docker build -t aem_6-1_base -t aem_6-1_base:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM base/.
    # now for author
    #- docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest || true
    - docker build -t aem_6-1_author -t aem_6-1_author:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM author/.
    # now for publish
    #- docker pull 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest || true
    - docker build -t aem_6-1_publish -t aem_6-1_publish:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest -t 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM publish/.

test:
  override:
    # make sure we can run the container
    - docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM /bin/sh -c ps aux
    #- docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM /bin/sh -c ps aux
    #- docker run 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM /bin/sh -c ps aux

deployment:
  production:
    branch: master
    commands:
      # login again for good measure, and push both the latest tag and tagged by build number images
      # push base
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_base:$CIRCLE_BUILD_NUM
      # push author
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_author:$CIRCLE_BUILD_NUM
      # push publish
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:latest
      - docker push 781401380984.dkr.ecr.us-east-1.amazonaws.com/aem_6-1_publish:$CIRCLE_BUILD_NUM